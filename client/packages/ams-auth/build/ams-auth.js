Ext.define("AmsAuth.crypto.Sha1",{singleton:true,hash:function(h){if(typeof String.prototype.utf8Encode==="undefined"){String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}}if(typeof String.prototype.utf8Decode==="undefined"){String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(a){return this}}}h=h.utf8Encode();var n=[1518500249,1859775393,2400959708,3395469782];h+=String.fromCharCode(128);var x=h.length/4+2;var k=Math.ceil(x/16);var m=new Array(k);for(var z=0;z<k;z++){m[z]=new Array(16);for(var y=0;y<16;y++){m[z][y]=(h.charCodeAt(z*64+y*4)<<24)|(h.charCodeAt(z*64+y*4+1)<<16)|(h.charCodeAt(z*64+y*4+2)<<8)|(h.charCodeAt(z*64+y*4+3))}}m[k-1][14]=((h.length-1)*8)/Math.pow(2,32);m[k-1][14]=Math.floor(m[k-1][14]);m[k-1][15]=((h.length-1)*8)&4294967295;var u=1732584193;var r=4023233417;var q=2562383102;var p=271733878;var o=3285377520;var f=new Array(80);var E,D,C,B,A;for(var z=0;z<k;z++){for(var v=0;v<16;v++){f[v]=m[z][v]}for(var v=16;v<80;v++){f[v]=AmsAuth.crypto.Sha1.ROTL(f[v-3]^f[v-8]^f[v-14]^f[v-16],1)}E=u;D=r;C=q;B=p;A=o;for(var v=0;v<80;v++){var w=Math.floor(v/20);var g=(AmsAuth.crypto.Sha1.ROTL(E,5)+AmsAuth.crypto.Sha1.f(w,D,C,B)+A+n[w]+f[v])&4294967295;A=B;B=C;C=AmsAuth.crypto.Sha1.ROTL(D,30);D=E;E=g}u=(u+E)&4294967295;r=(r+D)&4294967295;q=(q+C)&4294967295;p=(p+B)&4294967295;o=(o+A)&4294967295}return AmsAuth.crypto.Sha1.toHexStr(u)+AmsAuth.crypto.Sha1.toHexStr(r)+AmsAuth.crypto.Sha1.toHexStr(q)+AmsAuth.crypto.Sha1.toHexStr(p)+AmsAuth.crypto.Sha1.toHexStr(o)},f:function(b,a,d,c){switch(b){case 0:return(a&d)^(~a&c);case 1:return a^d^c;case 2:return(a&d)^(a&c)^(d&c);case 3:return a^d^c}},ROTL:function(a,b){return(a<<b)|(a>>>(32-b))},toHexStr:function(d){var c="",a;for(var b=7;b>=0;b--){a=(d>>>(b*4))&15;c+=a.toString(16)}return c}});Ext.define("AmsAuth.util.Authentification",{extend:"Ext.util.Observable",requires:["AmsLocale.util.Locale"],singleton:true,apiKey:null,userNom:null,userPrenom:null,userLogin:null,userAvatar:null,userRights:null,userParamStore:null,authenticateFromCookies:function(a,d){console.log("authenticateFromCookies");var c=Ext.util.Cookies.get("userLogin");var b=Ext.util.Cookies.get("userPass");if(c!==null&&b!==null){console.log("authenticateFromCookies : "+c+" "+b);this.authenticate(c,b,a,d)}else{d()}},authenticate:function(c,b,a,d){Ext.Ajax.request({url:"../../serveur/web/app_dev.php/Authenticate/"+c+"/"+b,success:function(e){var h=Ext.JSON.decode(e.responseText,true);if(h!==null){if(h.apiKey!==undefined&&h.apiKey!==null){AmsAuth.util.Authentification.setApiKey(h.apiKey);AmsAuth.util.Authentification.setUserNom(h.nom);AmsAuth.util.Authentification.setUserPrenom(h.prenom);AmsAuth.util.Authentification.setUserAvatar(h.avatar);AmsAuth.util.Authentification.setUserLogin(h.login);AmsAuth.util.Authentification.setUserRights(h.rights);var f=new Date();var g=new Date(f.getTime()+365*24*60*60*1000);Ext.util.Cookies.set("userLogin",c,g);Ext.util.Cookies.set("userPass",b,g);a(h.apiKey);AmsAuth.util.Authentification.fireEvent("authentificationInfoAvailable")}else{d(AmsLocale.util.Locale.txtAuthErreur,AmsLocale.util.Locale.txtAuthErreurMauvaiseReponse)}}else{d(AmsLocale.util.Locale.txtAuthErreur,AmsLocale.util.Locale.txtAuthErreurMauvaiseReponse)}},failure:function(){d(AmsLocale.util.Locale.txtAuthErreur,AmsLocale.util.Locale.txtAuthErreurMauvaiseLogin)}})},setApiKey:function(a){AmsAuth.util.Authentification.apiKey=a},setUserNom:function(a){AmsAuth.util.Authentification.userNom=a},setUserPrenom:function(a){AmsAuth.util.Authentification.userPrenom=a},setUserAvatar:function(a){AmsAuth.util.Authentification.userAvatar=a},setUserLogin:function(a){AmsAuth.util.Authentification.userLogin=a},setUserRights:function(a){AmsAuth.util.Authentification.userRights=a;console.log(a)},canConnectToAdmin:function(){for(var a=0;a<AmsAuth.util.Authentification.userRights.Prf.functions.length;a++){var b=AmsAuth.util.Authentification.userRights.Prf.functions[a];if(b.functionName==="connect_to_admin"&&b.exec===true){console.log("connexion administration autoris?");return true}}return false},canConnectToSig:function(){console.log(AmsAuth.util.Authentification.userRights);for(var a=0;a<AmsAuth.util.Authentification.userRights.Sig.functions.length;a++){var b=AmsAuth.util.Authentification.userRights.Sig.functions[a];if(b.functionName==="connect_to_sig"&&b.exec===true){console.log("connexion sig autoris?");return true}}return false},canEditSigTheme:function(){for(var a=0;a<AmsAuth.util.Authentification.userRights.Sig.functions.length;a++){var b=AmsAuth.util.Authentification.userRights.Sig.functions[a];if(b.functionName==="edit_sig_theme"&&b.exec===true){console.log("edition theme sig autoris?");return true}}return false}});Ext.define("AmsMain.view.AccountController",{extend:"Ext.app.ViewController",requires:[],alias:"controller.auth-account",init:function(){}});Ext.define("AmsAuth.view.Account",{extend:"Ext.window.Window",requires:["AmsLocale.util.Locale","AmsMain.view.AccountController","AmsAuth.util.Authentification"],controller:"auth-account",xtype:"ams-auth-account",modal:true,minWidth:300,minHeight:300,layout:{type:"vbox",align:"stretch"},initComponent:function(){var d=this;this.setTitle(AmsLocale.util.Locale.txtTitreCompte);var c=[];for(var e in AmsAuth.util.Authentification.userRights){if(AmsAuth.util.Authentification.userRights.hasOwnProperty(e)){var b=AmsAuth.util.Authentification.userRights[e];var a=Ext.create("Ext.form.field.Text",{readOnly:true,margin:4,fieldLabel:b.displayName,value:b.profil});c.push(a)}}this.items=[{xtype:"container",items:[{xtype:"image",width:64,border:true,height:64,margin:4,src:AmsAuth.util.Authentification.userAvatar}]},{xtype:"textfield",readOnly:true,margin:4,fieldLabel:AmsLocale.util.Locale.txtNom,value:AmsAuth.util.Authentification.userNom},{xtype:"textfield",readOnly:true,margin:4,fieldLabel:AmsLocale.util.Locale.txtPrenom,value:AmsAuth.util.Authentification.userPrenom},{xtype:"panel",title:"Profils",flex:1,layout:{type:"vbox",align:"stretch"},items:c}];this.callParent(arguments)}});Ext.define("AmsAuth.view.ToolAccount",{requires:["AmsLocale.util.Locale","AmsAuth.view.Account"],extend:"Ext.button.Button",xtype:"ams-tool-account",scale:"medium",icon:"resources/icons/24x24/account.png",listeners:{click:function(){this.showAccountWindow()}},showAccountWindow:function(){var a=Ext.create("AmsAuth.view.Account");a.show()},initComponent:function(){this.setText(AmsLocale.util.Locale.txtMonCompte);this.callParent(arguments)}});Ext.define("AmsAuth.view.ToolDisconnect",{requires:["AmsLocale.util.Locale"],extend:"Ext.button.Button",xtype:"ams-tool-disconnect",text:"D?connexion",scale:"medium",icon:"resources/icons/24x24/disconnect.png",initComponent:function(){this.setText(AmsLocale.util.Locale.txtDeconnexion);this.callParent(arguments)}});Ext.define("AmsMain.view.AuthToolbarController",{extend:"Ext.app.ViewController",requires:[],alias:"controller.auth-toolbar",init:function(){var a=this;AmsAuth.util.Authentification.on("authentificationInfoAvailable",function(){a.updateUserInfo.call(a)})},updateUserInfo:function(){var c=this.lookupReference("lblPrenom");var a=this.lookupReference("lblNom");var b=this.lookupReference("imgAvatar");c.setText(AmsAuth.util.Authentification.userPrenom);a.setText(AmsAuth.util.Authentification.userNom);b.setSrc(AmsAuth.util.Authentification.userAvatar)}});Ext.define("AmsAuth.view.AuthToolbar",{extend:"Ext.container.Container",requires:["AmsLocale.util.Locale","AmsAuth.view.ToolAccount","AmsAuth.view.ToolDisconnect","AmsLocale.view.locale.ComboLanguage","AmsAuth.util.Authentification","AmsMain.view.AuthToolbarController"],controller:"auth-toolbar",xtype:"ams-auth-toolbar",layout:{type:"hbox",align:"middle",pack:"end"},initComponent:function(){var a=this;this.items=[{xtype:"image",width:64,height:64,margin:4,reference:"imgAvatar"},{xtype:"container",layout:"vbox",items:[{xtype:"label",reference:"lblPrenom",cls:"x-btn-inner-default-medium"},{xtype:"label",reference:"lblNom",cls:"x-btn-inner-default-medium"},{xtype:"ams-combo-lang",margin:4}]},{xtype:"container",layout:"vbox",items:[{xtype:"ams-tool-account",width:200,margin:4},{xtype:"ams-tool-disconnect",margin:4,width:200,listeners:{click:function(){a.fireEvent("disconnectClick")}}}]}];this.callParent(arguments)}});Ext.define("AmsMain.view.LoginController",{extend:"Ext.app.ViewController",requires:["AmsAuth.util.Authentification","Ext.window.MessageBox","AmsAuth.crypto.Sha1","AmsLocale.util.Locale"],alias:"controller.login",onConnectButtonClick:function(){var d=this;var b=this.getViewModel().get("login");var c=this.getViewModel().get("password");var a=AmsAuth.crypto.Sha1.hash(c);d.getView().mask(AmsLocale.util.Locale.txtAuthentification+" ...");AmsAuth.util.Authentification.authenticate(b,a,function(e){d.onAuthenticateSuccess.call(d,e)},function(f,e){d.onAuthenticateFailure.call(d,f,e)})},onAuthenticateSuccess:function(a){this.getView().unmask();this.fireViewEvent("loginSuccess")},onAuthenticateFailure:function(b,a){this.getView().unmask();Ext.Msg.alert(b,a)}});Ext.define("AmsMain.view.LoginModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.login",data:{login:"",password:""}});Ext.define("AmsAuth.view.Login",{extend:"Ext.panel.Panel",requires:["AmsMain.view.LoginController","AmsMain.view.LoginModel","AmsLocale.util.Locale"],xtype:"ams-login",controller:"login",viewModel:{type:"login"},layout:{type:"vbox",align:"center",pack:"center"},initComponent:function(){this.items=[{xtype:"panel",title:AmsLocale.util.Locale.txtAuthentification,border:true,items:[{xtype:"form",items:[{xtype:"textfield",reference:"txtLogin",allowBlank:false,minLength:2,fieldLabel:AmsLocale.util.Locale.txtLogin,labelWidth:150,margin:4,bind:{value:"{login}"}},{xtype:"textfield",allowBlank:false,reference:"txtPassword",fieldLabel:AmsLocale.util.Locale.txtPassword,inputType:"password",labelWidth:150,minLength:2,margin:4,bind:{value:"{password}"}}],buttons:[{text:AmsLocale.util.Locale.txtConnexion,formBind:true,disabled:true,scale:"medium",icon:"resources/icons/24x24/connect.png",handler:"onConnectButtonClick"}]}]}];this.callParent(arguments)}});